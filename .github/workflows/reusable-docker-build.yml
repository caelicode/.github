name: Reusable Docker Build

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Docker image name (without registry prefix)'
        required: true
        type: string
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'ghcr.io'
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64'
      push:
        description: 'Push image to registry'
        required: false
        type: boolean
        default: true
      tag-strategy:
        description: 'Tagging: sha, semver, latest, or custom'
        required: false
        type: string
        default: 'sha'
      build-args:
        description: 'Docker build arguments (newline-separated KEY=VALUE)'
        required: false
        type: string
        default: ''
      runner:
        description: 'Runner label(s) as JSON array'
        required: false
        type: string
        default: '["ubuntu-latest"]'
    secrets:
      registry-username:
        description: 'Registry username (default: github.actor for ghcr.io)'
        required: false
      registry-password:
        description: 'Registry password/token (default: GITHUB_TOKEN for ghcr.io)'
        required: false

jobs:
  build:
    runs-on: ${{ fromJSON(inputs.runner) }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Set up QEMU
        if: contains(inputs.platforms, ',')
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Login to registry
        if: inputs.push
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry-username || github.actor }}
          password: ${{ secrets.registry-password || github.token }}

      - name: Generate tags
        id: tags
        run: |
          IMAGE="${{ inputs.registry }}/${{ github.repository_owner }}/${{ inputs.image-name }}"
          TAGS=""

          case "${{ inputs.tag-strategy }}" in
            sha)
              TAGS="${IMAGE}:${GITHUB_SHA::7}"
              ;;
            semver)
              REF="${GITHUB_REF#refs/tags/}"
              TAGS="${IMAGE}:${REF}"
              TAGS="${TAGS},${IMAGE}:latest"
              ;;
            latest)
              TAGS="${IMAGE}:latest"
              ;;
            *)
              TAGS="${IMAGE}:${{ inputs.tag-strategy }}"
              ;;
          esac

          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push }}
          tags: ${{ steps.tags.outputs.tags }}
          build-args: ${{ inputs.build-args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
