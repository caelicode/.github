name: Secret Rotation Reminder

on:
  workflow_call:
  schedule:
    # Run on the 1st and 15th of each month at 09:00 UTC
    - cron: '0 9 1,15 * *'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  check-rotation:
    runs-on: [self-hosted, linux, x64]
    steps:
      - name: Check for upcoming secret expirations
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const ROTATION_DAYS = 90;
            const WARNING_DAYS = 10;

            // This workflow creates a reminder issue if one doesn't already exist
            const title = `Secret Rotation Reminder â€” ${new Date().toISOString().slice(0, 7)}`;

            // Check if issue already exists this month
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'secret-rotation',
            });

            const existing = issues.find(i => i.title.includes(new Date().toISOString().slice(0, 7)));
            if (existing) {
              core.info(`Rotation reminder already exists: #${existing.number}`);
              return;
            }

            const body = `## Monthly Secret Rotation Check

            Please verify the following secrets are not expired or approaching expiry:

            | Secret | Location | Last Rotated | Action Needed |
            |--------|----------|-------------|---------------|
            | \`GH_PAT\` | Dispatcher VM + GitHub Secrets | _Check manually_ | Rotate if > ${ROTATION_DAYS} days |
            | \`GRAFANA_API_KEY\` | status-page Secrets | _Check manually_ | Rotate if > ${ROTATION_DAYS} days |
            | \`GRAFANA_SM_TOKEN\` | status-page Secrets | _Check manually_ | Rotate if > ${ROTATION_DAYS} days |
            | \`STATUSPAGE_API_KEY\` | status-page Secrets | _Check manually_ | Rotate if > ${ROTATION_DAYS} days |
            | \`SMTP_PASSWORD\` | Multiple repo Secrets | _Check manually_ | Rotate on provider change |

            ### Rotation Procedure
            See [RUNBOOK.md](https://github.com/caelicode/runner-infrastructure/blob/main/RUNBOOK.md#secret-rotation-procedures) for detailed steps.

            > Auto-generated by the secret rotation reminder workflow.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['secret-rotation', 'maintenance'],
            });

            core.info('Created rotation reminder issue');
